#!/usr/bin/env php
<?php

require_once(__DIR__ . '/../lib/Plainflow.php');

if (in_array('--help', $argv)) {
  print(usage());
  exit;
}

if (empty($_ENV['PLAINFLOW_SECRET_KEY'])) {
  error('$PLAINFLOW_SECRET_KEY environment variable required');
}

date_default_timezone_set('UTC');
Plainflow::init($_ENV['PLAINFLOW_SECRET_KEY']);

$options = getopt('', [
  'method:',        // T I P G A
  'event::',        // x
  'userId::',      // x x x x x
  'groupId::',     //       x
  'previousId::',  //         x
  'anonymousId::', // x x x x x
  'properties::',   // x   x
  'name::',         //     x
  'traits::',       //   x   x
  'context::',      // x x x x x
  'timestamp::'     // x x x x x
]);


switch ($options['method']) {
  case 'track':
    Plainflow::track(array(
      'userId' => $options['userId'],
      'anonymousId' => $options['anonymousId'],
      'event' => $options['event'],
      'properties' => parse_json($options['properties']),
      'timestamp' => parse_timestamp($options['timestamp']),
      'context' => parse_json($options['context'])
    ));
    break;

  case 'identify':
    Plainflow::identify(array(
      'userId' => $options['userId'],
      'anonymousId' => $options['anonymousId'],
      'traits' => parse_json($options['traits']),
      'timestamp' => parse_timestamp($options['timestamp']),
      'context' => parse_json($options['context'])
    ));
    break;

  case 'page':
    Plainflow::page(array(
      'userId' => $options['userId'],
      'anonymousId' => $options['anonymousId'],
      'name' => $options['name'],
      'category' => $options['category'],
      'properties' => parse_json($options['properties']),
      'timestamp' => parse_timestamp($options['timestamp']),
      'context' => parse_json($options['context'])
    ));
    break;

  case 'group':
    Plainflow::identify(array(
      'userId' => $options['userId'],
      'anonymousId' => $options['anonymousId'],
      'groupId' => $options['groupId'],
      'traits' => parse_json($options['traits']),
      'timestamp' => parse_timestamp($options['timestamp']),
      'context' => parse_json($options['context'])
    ));
    break;

  case 'alias':
    Plainflow::alias(array(
      'userId' => $options['userId'],
      'previousId' => $options['previousId']
    ));
    break;

  default:
    error(usage());
    break;
}

Plainflow::flush();

function usage() {
  return "\n  Usage: plainflow --method <track|identify|page|group|alias> [options]\n\n";
}

function error($message) {
  print("$message\n\n");
  exit(1);
}

function parse_json($input) {
  if (empty($input)) {
    return null;
  }

  return json_decode($input);
}

function parse_timestamp($input) {
  if (empty($input)) {
    return null;
  }

  return strtotime($input);
}
